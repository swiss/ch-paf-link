<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
<script src="https://linkeddata.github.io/rdflib.js/dist/rdflib.min.js"></script>
    <script>
      async function generateTableForClassInRespec(className, domain, targetElement) {
        const rdf = $rdf;
        const store = rdf.graph();
        const ttlFileUrl = './ch-paf-link.ttl';
        const baseUri = new URL(ttlFileUrl, window.location.href).href;
        const contentType = 'text/turtle';

        let prefixes = {};
        try {
          const response = await fetch(ttlFileUrl);
          if (!response.ok) {
            throw new Error(`Failed to load TTL file: ${response.statusText}`);
          }
          const ttlData = await response.text();

          const prefixRegex = /@prefix\s+([a-zA-Z0-9\-]+):\s+<([^>]+)>/g;
          let match;
          while ((match = prefixRegex.exec(ttlData)) !== null) {
            prefixes[match[1]] = match[2];
          }

          rdf.parse(ttlData, store, baseUri, contentType);

          const sparqlQuery = `
            
            PREFIX onto: <https://onto.link/>
          
            SELECT ?subject ?predicate ?object
            WHERE {
              ?subject a <${className}> .
              ?subject onto:group '${domain}' .
              ?subject ?predicate ?object .
            }
          `;

          const query = rdf.SPARQLToQuery(sparqlQuery, false, store);
          const queryResults = store.querySync(query);

          const groupedResults = {};
          queryResults.forEach(result => {
            const subject = result['?subject'].value;
            if (!groupedResults[subject]) {
              groupedResults[subject] = [];
            }
            groupedResults[subject].push({
              predicate: result['?predicate'].value,
              object: result['?object'].value,
            });
          });

          function applyPrefix(uri) {
            for (const prefix in prefixes) {
              if (uri.startsWith(prefixes[prefix])) {
                return uri.replace(prefixes[prefix], `${prefix}:`);
              }
            }
            return uri;
          }

          const target = document.querySelector(`#${targetElement}`);
          target.innerHTML = '';

          for (const subject in groupedResults) {
            const subjectData = groupedResults[subject];

            const subjectSection = document.createElement('div');
            target.appendChild(subjectSection);

            const subjectHeader = document.createElement('h3');
            subjectHeader.textContent = applyPrefix(subject);
            subjectSection.appendChild(subjectHeader);

            const table = document.createElement('table');
            table.classList.add('table', 'table-bordered', 'table-striped');
            subjectSection.appendChild(table);

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const thPredicate = document.createElement('th');
            thPredicate.textContent = 'Predicate';
            const thObject = document.createElement('th');
            thObject.textContent = 'Object';
            headerRow.appendChild(thPredicate);
            headerRow.appendChild(thObject);
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            subjectData.forEach(item => {
              const row = document.createElement('tr');
              const tdPredicate = document.createElement('td');
              tdPredicate.textContent = applyPrefix(item.predicate);
              const tdObject = document.createElement('td');
              tdObject.textContent = applyPrefix(item.object);
              row.appendChild(tdPredicate);
              row.appendChild(tdObject);
              tbody.appendChild(row);
            });
            table.appendChild(tbody);
          }
        } catch (error) {
          console.error('Error generating table:', error);
        }
      }

    function populateTables() {
        generateTableForClassInRespec('http://www.w3.org/2002/07/owl#Class', 'Parliamentary Affair', 'parliamentary-affair-classes');

        generateTableForClassInRespec('http://www.w3.org/2002/07/owl#DatatypeProperty', 'Parliamentary Affair', 'parliamentary-affair-datatype-properties');
    }

      function jumpTo(config) {
        let element = document.getElementById(location.pathname.substr(location.pathname.lastIndexOf("/")+1));
        if(element !== null && typeof element !== "undefined")
            element.scrollIntoView(true)
      }

      async function loadTurtle() {
        //this is the function you call in 'preProcess', to load the highlighter
        const worker = await new Promise(resolve => {
          require(["core/worker"], ({ worker }) => resolve(worker));
        });
        const action = "highlight-load-lang";
        const langURL =
          "https://swiss.github.io/paf-link/turtle.js";
        const propName = "turtle"; // This funtion is defined in the highlighter being loaded
        const lang = "turtle"; // this is the class you use to identify the language
        worker.postMessage({ action, langURL, propName, lang });
        return new Promise(resolve => {
          worker.addEventListener("message", function listener({ data }) {
            const { action: responseAction, lang: responseLang } = data;
            if (responseAction === action && responseLang === lang) {
              worker.removeEventListener("message", listener);
              resolve();
            }
          });
        });
      }
    </script>
    <script type="text/javascript" src='https://www.w3.org/Tools/respec/respec-w3c' async class='remove'></script>
    <script class="remove" src="https://cdn.jsdelivr.net/gh/w3c/respec-mermaid@1.1.0/dist/main.js"></script>
    <script class='remove'>
      var module = {}
    </script>
    <script type="text/javascript" src='config.js' class='remove'></script>
    <title>ch.paf.link: Swiss Public Affairs</title>
  </head>
  <body>

    <section id='abstract' data-include-format="markdown" data-include="documentation/1_abstract.md"></section>
    
    <section id='issue-summary'></section>

    <section id='sotd'></section>

    <section id='introduction' data-include-format="markdown" data-include="documentation/2_introduction.md"></section>

    <section id='parliamentary-affair' data-include-format="markdown" data-include="documentation/3_parliamentary_affair.md"></section>

    <section id='procedural-request' data-include-format="markdown" data-include="documentation/4_procedural_request.md"></section>

    <section id='references'></section>
    
   </body>
</html>
